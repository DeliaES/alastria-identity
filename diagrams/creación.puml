@startuml
actor User <<Móvil>>
actor User_Web <<Browser/App>>
boundary Associate_Web
boundary  PushMovileManager
boundary Gateway
boundary MetaIdentityManager
boundary Proxy
boundary Registry

boundary Repository
autonumber
title
    Proceso de creación de identidad
end title
activate User
User->User: Instalación de la aplicación Alastria en el móvil

User_Web->Associate_Web: Solicitud del token de sesión
Associate_Web->User_Web: Entrega del token de sesión

group Creación de identidad
User_Web-->Associate_Web: Quiero darme de alta en alastria id
Associate_Web --> Associate_Web: Preparación de objeto JSON con el alta en alastria
Associate_Web --> PushMovileManager: Envío de la url de recuperación del JSON con el token de sesión
PushMovileManager --> User: Push de la url de recuperación del JSON

group Recuperación de la clave pública para verificar la información recuperada
    User->Gateway: Solicito la recuperación de la clave pública de la aplicación.
    activate Gateway
    Gateway->MetaIdentityManager: Aceptación de la llamada.
    deactivate Gateway
    activate MetaIdentityManager
    MetaIdentityManager->Proxy: Reenvío al proxy.
    deactivate MetaIdentityManager
    activate Proxy
    Proxy->Registry: Recupero la clave pública del usuario
    deactivate Proxy
    activate Registry
    Registry->Gateway: Clave pública del alastria_id asociada a la aplicación 
    deactivate Registry
    activate Gateway
    Gateway->User: Clave pública de alastria_id asociada a la aplicación
    deactivate Gateway
end

User --> User: Verificación de la firma del objeto JSON
User --> Gateway: Creación del alastria_id del usuario
note right Gateway: ¿Qué contrato se llama y qué consecuencias tiene?
Gateway --> User: Recuperación del alasitra_id del usuario
User --> User: Creación de claves
User --> Gateway: Publicación en el Registry de la clave pública
note right Gateway: ¿Qué contrato se llama y qué consecuencias tiene?
Gateway --> User: OK
end

note right User: Alastgria_ID creado
note right User: Se tiene una identidad vacia. Requirimiento de testimonios iniciales
note right User: La URL de recuperación de los atestados, se ha recibido en el JSON del push inicial

group Inclusión de testimonios
User --> Associate_Web: Solicitud de los atestados aportados por el socio
Associate_Web --> Associate_Web: Construcción de los atestados del usuario (JSON Firmado)
Associate_Web --> PushMovileManager: Envío de la URL de recuperación de los atestados
PushMovileManager --> User: Notificación Push con URL de recuperación de los atestados
alt no tengo la clave pública del alastria_id
  group Recuperación de la clave pública para verificar la información recuperada
    User->Gateway: Solicito la recuperación de la clave pública de la aplicación.
    activate Gateway
    Gateway->MetaIdentityManager: Aceptación de la llamada.
    deactivate Gateway
    activate MetaIdentityManager
    MetaIdentityManager->Proxy: Reenvío al proxy.
    deactivate MetaIdentityManager
    activate Proxy
    Proxy->Registry: Recupero la clave pública del usuario
    deactivate Proxy
    activate Registry
    Registry->Gateway: Clave pública del alastria_id asociada a la aplicación 
    deactivate Registry
    activate Gateway
    Gateway->User: Clave pública de alastria_id asociada a la aplicación
    deactivate Gateway
  end
end
User --> User: Verificación de la firma del objeto JSON
User --> User: Aceptación y firma de los atestados

User --> Repository: Almacenamiento del atestado
Repository --> User: Uri de recuperación

User --> Gateway: Registro de los atributo en registry
Gateway -> MetaIdentityManager: Crear nuevo atributo (hash JWT y/o URI)
MetaIdentityManager -> Proxy: Crear nuevo atributo (hash JWT y/o URI)
Proxy -> Gateway: Crear nuevo atributo (hash JWT y/o URI)
Registry -> Gateway: Nuevo evento LogNewAttribute(hash JWT y/o URI)
Gateway --> User: Registro OK
end

deactivate User
@enduml
